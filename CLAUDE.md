# yatagarrage - 開発者向けドキュメント

## プロジェクト概要

React + Vite + TypeScript + Phaser 3 で作成したブラウザベースの弾幕シューティングゲーム。スマホ・PC両対応で、30種類以上の弾幕パターンを実装しています。

## 技術スタック

### フロントエンド

- **React 18**: UIコンポーネントの管理
- **Vite 6**: 高速なビルドツール
- **TypeScript 5**: 型安全な開発
- **Phaser 3**: ゲームエンジン（物理演算、描画、入力処理）

### スタイリング・品質管理

- **Tailwind CSS 4**: ユーティリティファーストのCSS
- **ESLint**: コード品質チェック
- **Prettier**: コードフォーマット
- **Husky + lint-staged**: コミット前の自動チェック

## プロジェクト構造

```
yatagarrage/
├── src/
│   ├── game/
│   │   ├── MainScene.ts       # メインゲームシーン（ゲームロジック）
│   │   ├── gravityField.ts    # 重力場システム
│   │   └── config.ts          # Phaser設定
│   ├── App.tsx                # Reactアプリケーションルート
│   └── main.tsx               # エントリーポイント
├── public/                    # 静的アセット
├── .serena/                   # MCPサーバー設定
└── package.json
```

## 主要コンポーネント

### MainScene (src/game/MainScene.ts)

ゲームのメインロジックを担当するPhaserシーンクラス。

#### 主要な機能

1. **プレイヤー管理**
   - 三角形の自機（青色）
   - キーボード・タップ両対応の移動制御
   - 弾の発射制御（連射レート: 200ms）

2. **弾幕システム**
   - 30種類以上の弾幕パターン
   - 敵ごとに異なるパターンを選択
   - 重力場による弾道変化

3. **敵管理**
   - 定期的なスポーン（1秒ごと）
   - 各敵が独立した射撃タイマーを保持
   - 破壊時のタイマークリーンアップ

4. **残像エフェクト**
   - プレイヤー・弾・敵・敵弾すべてに残像を生成
   - フレームごとにアルファ値を減衰
   - メモリリーク防止のため古い残像を自動削除

5. **UI要素**
   - スコア表示
   - ステージ名（縦書き）
   - デバッグ情報（座標、オブジェクト数）
   - 青い帯のデザイン

6. **入力処理**
   - キーボード: 矢印キー（移動）、スペースキー（射撃）
   - タッチ: 中央部タップで移動、外周タップで射撃
   - ビジュアルインジケーター表示

### GravityField (src/game/gravityField.ts)

弾道に影響を与える重力場システム。敵弾に重力を適用して弾道を曲げます。

## 弾幕パターン一覧（全35種類）

MainSceneには以下の弾幕パターンが実装されています：

### 基本パターン（1-5）

1. **扇状弾幕（5-way）** - プレイヤー方向へ扇状に5発発射
2. **円形弾幕（8方向）** - 8方向へ均等に発射
3. **円形弾幕（16方向）** - 16方向へ均等に発射
4. **円形弾幕（24方向）** - 24方向へ均等に発射
5. **円形弾幕（32方向）** - 32方向へ均等に発射、密度の高い全方位弾幕

### 螺旋系パターン（6-8）

6. **シングルスパイラル** - 1本の螺旋状弾幕
7. **ダブルスパイラル** - 2本の螺旋状弾幕
8. **トリプルスパイラル** - 3本の螺旋状弾幕

### 特殊軌道系（9-12）

9. **波状弾幕** - サイン波の軌道で動く弾
10. **ランダム弾幕** - ランダムな方向と速度で発射
11. **収束弾幕** - 画面中央に向かって徐々に収束
12. **拡散弾幕** - 画面中央から徐々に拡散

### 幾何学パターン（13-15）

13. **十字型** - 上下左右の4方向
14. **X字型** - 斜め4方向
15. **米字型** - 8方向（十字+X字）

### ホーミング・追尾系（16, 35）

16. **ホーミング弾** - プレイヤーを追尾する弾
17. **ランダム方向ホーミング** - 最初はランダム、途中からホーミング

### 速度変化系（17-18）

17. **加速弾** - 徐々に加速する弾
18. **減速弾** - 徐々に減速する弾

### 時間差・多段系（19-20）

19. **二段階弾幕** - 途中でプレイヤー方向へ方向転換
20. **時間差弾幕** - 100msずつ時間差で連続発射

### 密度系（21-22）

21. **密集弾幕** - プレイヤー方向へ密集した20発
22. **まばら弾幕** - プレイヤー方向へまばらに4発

### 扇形バリエーション（23-24）

23. **扇形集中** - 狭い角度で7発
24. **扇形分散** - 広い角度で7発

### 多重円形（25-26）

25. **ダブル円形** - 異なる速度で2重の円形弾幕
26. **トリプル円形** - 異なる速度で3重の円形弾幕

### 連射系（27-28）

27. **バースト弾** - 3回に分けて8方向へバースト
28. **ストリーム弾** - 連続して10発を高速発射

### 狙撃系（29-30）

29. **直線自機狙い** - プレイヤーへ直線発射
30. **予測弾** - プレイヤーの移動を予測して発射

### 爆発・拡散（31）

31. **爆発型** - 16方向へランダム速度で爆発的に発射

### 回転系（32-33）

32. **回転弾幕（時計回り）** - 6方向が時計回りに回転
33. **回転弾幕（反時計回り）** - 6方向が反時計回りに回転

### 花弁状（34）

34. **花弁状** - 5つの花弁のような形状で発射

## パターンの技術詳細

各パターンは以下の特殊データフラグで挙動を制御しています：

- `homing`: ホーミング機能を有効化
- `accelerating`: 加速機能を有効化
- `decelerating`: 減速機能を有効化
- `wave`: 波状移動を有効化
- `converging`: 収束挙動を有効化
- `diverging`: 拡散挙動を有効化
- `twoStage`: 二段階挙動を有効化
- `homingDelay`: ホーミング開始までの遅延時間
- `stageTime`: 段階切り替えの時間

これらのフラグは`applyGravityToEnemyBullets`メソッド内で毎フレームチェックされ、特殊な挙動が適用されます。

各パターンは`enemyShoot`メソッド内でswitch文により実装され、敵の生成時に1-35のパターンIDがランダムに割り当てられます（src/game/MainScene.ts:222）。

## 物理エンジンの設定

### 衝突判定

- プレイヤー vs 敵
- プレイヤー vs 敵弾
- プレイヤー弾 vs 敵

### 境界設定

- プレイヤー: ワールド境界で反発
- 弾: 画面外で自動削除（マージン付き）
- 敵: 下端を超えたら削除

## 開発コマンド

```bash
# 依存関係のインストール
npm install

# 開発サーバーを起動（ホットリロード有効）
npm run dev

# プロダクションビルド
npm run build

# ビルド結果のプレビュー
npm run preview

# コードフォーマット（Prettier）
npm run format

# Lintチェック（ESLint）
npm run lint

# 型チェック
npx tsc --noEmit
```

## デバッグ

### デバッグモード

アプリケーションには**デバッグモード**が搭載されています。メニュー画面で「デバッグモード」ボタンをクリックすると起動します。

#### デバッグモードの機能

1. **弾幕パターンボタン（001-035）**
   - 画面上部に35個のボタンが並びます
   - 各ボタンをクリックすると、対応する弾幕パターンが即座に画面中央から発射されます
   - パターンの挙動を個別にテストできます
   - ボタンにマウスカーソルを合わせると、パターンの説明がツールチップで表示されます

2. **弾をクリアボタン**
   - 画面上のすべての弾を即座に削除します
   - 次のパターンをクリーンな状態でテストできます

3. **重力源ON/OFFボタン**
   - 重力場システムの有効/無効を切り替えます
   - 弾幕パターンが重力の影響を受ける様子を確認できます
   - 重力なしでパターン本来の形状を見ることもできます

#### デバッグモードの活用法

- **新しいパターンの開発時**: パターンを追加したら、デバッグモードで即座に動作確認
- **バランス調整**: 各パターンの速度、密度、角度などを調整し、その場で確認
- **重力との相互作用テスト**: 重力ON/OFFを切り替えて、弾道変化を観察
- **パターン組み合わせの検討**: 複数のボタンを連続でクリックして、パターンの相性をチェック

#### 弾幕パターンの定義ファイル

デバッグモードで使用される弾幕パターンは `src/game/patterns.ts` で定義されています。

```typescript
export const DANMAKU_PATTERNS: DanmakuPattern[] = [
  {
    id: '001-line-rain',
    label: '001: 直線弾雨',
    description: '正面からまっすぐ降り注ぐ基本パターン',
    script: ({ origin, spawn }) => {
      // パターンのロジック
    },
  },
  // ... 035まで
]
```

各パターンは以下の構造を持ちます：

- `id`: パターンの一意な識別子
- `label`: ボタンに表示されるラベル
- `description`: ツールチップで表示される説明文
- `script`: 弾を発射するロジック関数

新しいパターンを追加する場合は、この配列に新しいオブジェクトを追加するだけです。

### ゲーム内デバッグ情報

画面下部の青い帯にリアルタイムで以下の情報が表示されます：

- プレイヤー座標
- アクティブな弾の数
- アクティブな敵の数
- アクティブな敵弾の数

### ブラウザ開発者ツール

- `F12`でDevToolsを開く
- Consoleでエラーやログを確認
- Performanceタブでフレームレートを監視

## パフォーマンス最適化

### オブジェクトプーリング

- 弾と敵弾はPhaser Groupでプール管理
- `maxSize`を設定して上限を制御

### 残像エフェクトの最適化

- 最大長を制限（デフォルト: 10ポイント）
- アルファ値0になったら即座に削除
- Graphicsオブジェクトの明示的なdestroy

### 描画の最適化

- 毎フレーム描画が必要なものだけ再描画
- 一時的なGraphicsは`delayedCall`で削除

## 新しい弾幕パターンの追加方法

1. `MainScene.ts`の`enemyShoot`メソッドを編集
2. 新しいパターンIDを追加
3. パターン選択ロジックに条件分岐を追加
4. 弾の生成・速度設定ロジックを実装

```typescript
private enemyShoot(enemy: Phaser.Physics.Arcade.Sprite, patternId: number) {
  switch(patternId) {
    case 1:
      // 既存の扇状弾幕
      break;
    case 2:
      // 新しい弾幕パターン
      const bulletCount = 8;
      for (let i = 0; i < bulletCount; i++) {
        const bullet = this.enemyBullets.get(enemy.x, enemy.y);
        const angle = (Math.PI * 2 * i) / bulletCount;
        // ...
      }
      break;
  }
}
```

## トラブルシューティング

### ビルドエラー

- `npm install`で依存関係を再インストール
- `node_modules`と`package-lock.json`を削除して再インストール

### 型エラー

- `npx tsc --noEmit`で型チェック
- Phaserの型定義が不足している場合は`@types/phaser`を確認

### パフォーマンス問題

- 残像の最大長を減らす
- 弾のmaxSizeを調整
- 敵のスポーン頻度を下げる

## ライセンス

MIT License - 詳細は LICENSE ファイルを参照

## 貢献

プルリクエストを歓迎します。大きな変更の場合は、まずissueで議論してください。
